name: FoodFast Full E2E Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-full-system:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Start Backend Services
      run: |
        docker compose up -d
        echo "⏳ Waiting for Backend to be ready (180s)..."
        sleep 180

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' 
        cache: 'npm'
        cache-dependency-path: foodfast-frontend/package-lock.json

    - name: Install, Start and Run Test
      env:
        VITE_API_BASE_URL: http://localhost:8080
        CI: true
      run: |
        cd foodfast-frontend
        
        # 1. Cài đặt thư viện
        npm ci
        
        # 2. Cài lại mochawesome (Bắt buộc để tạo báo cáo)
        npm install mochawesome --save-dev
        
        # 3. Bật Server
        npm start &
        npx wait-on http://localhost:5173 --timeout 60000
        
        # 4. CHẠY TEST TRỰC TIẾP (Không qua package.json để tránh lỗi script)
        # Lệnh này ép buộc tạo folder "my-report" chứa kết quả
        echo "🚀 Running tests..."
        npx mocha tests/*.spec.js --timeout 60000 --reporter mochawesome --reporter-options reportDir=my-report,reportFilename=index
      
      continue-on-error: true

    # Debug: Liệt kê file xem có folder my-report không
    - name: Debug - List Report Files
      if: always()
      run: |
        echo "📂 Checking for report files..."
        ls -R foodfast-frontend/my-report/ || echo "❌ KHÔNG TÌM THẤY FOLDER BÁO CÁO!"

    # 5. Upload folder "my-report"
    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: HTML-Test-Report
        path: foodfast-frontend/my-report/  # Đường dẫn khớp với lệnh npx mocha ở trên
        retention-days: 5

    - name: Teardown
      if: always()
      run: docker compose down