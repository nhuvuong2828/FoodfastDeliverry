name: FoodFast Full E2E Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-full-system:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Start Backend Services
      run: |
        docker compose up -d
        echo "⏳ Waiting for Backend to be ready (180s)..."
        sleep 180

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' 
        cache: 'npm'
        cache-dependency-path: foodfast-frontend/package-lock.json

    - name: Install, Start and Run Test
      env:
        VITE_API_BASE_URL: http://localhost:8080
        CI: true
      run: |
        cd foodfast-frontend
        
        # --- BƯỚC SỬA LỖI TỰ ĐỘNG ---
        echo "🔧 Fixing package.json encoding..."
        # Lệnh này sẽ tìm và xóa ký tự BOM ở đầu file (nguyên nhân gây lỗi ERR_MOCHA_UNPARSABLE_FILE)
        sed -i '1s/^\xEF\xBB\xBF//' package.json
        # ----------------------------
        
        # Dùng npm install để an toàn hơn khi file package.json vừa bị sửa
        npm install
        
        # Cài mochawesome
        npm install mochawesome --save-dev
        
        # Bật Server
        npm start &
        npx wait-on http://localhost:5173 --timeout 60000
        
        # CHẠY TEST VÀ XUẤT BÁO CÁO
        echo "🚀 Running tests..."
        npx mocha tests/*.spec.js --timeout 60000 --reporter mochawesome --reporter-options reportDir=my-report,reportFilename=index
      
      continue-on-error: true

    # Debug: Kiểm tra xem file báo cáo có chưa
    - name: Debug - List Report Files
      if: always()
      run: |
        echo "📂 Checking report files..."
        ls -R foodfast-frontend/my-report/ || echo "❌ VẪN CHƯA CÓ FILE BÁO CÁO!"

    # Upload báo cáo
    - name: Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: HTML-Test-Report
        path: foodfast-frontend/my-report/
        retention-days: 5

    - name: Teardown
      if: always()
      run: docker compose down